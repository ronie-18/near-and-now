-- ============================================================================
-- PART 2: Functions, Triggers, Views, Sample Data
-- Run this AFTER merged_schema_part1_tables.sql
-- ============================================================================

-- ============================================================================
-- ============================================================================
-- SECTION 9: FUNCTIONS & TRIGGERS
-- ============================================================================
-- NOTE: All functions MUST be created BEFORE triggers that use them
-- ============================================================================

-- ===== FUNCTIONS =====

CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = now();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE OR REPLACE FUNCTION calculate_customer_order_total(customer_order_id_param uuid)
RETURNS numeric AS $$
DECLARE
  items_total numeric;
  delivery_fee numeric;
  discount numeric;
BEGIN
  -- Sum of all store_order subtotals
  SELECT COALESCE(SUM(subtotal_amount), 0) INTO items_total
  FROM store_orders WHERE customer_order_id = customer_order_id_param;
  
  SELECT delivery_fee, discount_amount INTO delivery_fee, discount
  FROM customer_orders WHERE id = customer_order_id_param;
  
  RETURN items_total + COALESCE(delivery_fee, 0) - COALESCE(discount, 0);
END;
$$ LANGUAGE plpgsql;

CREATE OR REPLACE FUNCTION is_store_in_range(
  store_lat numeric,
  store_lng numeric,
  customer_lat numeric,
  customer_lng numeric,
  radius_km numeric
)
RETURNS boolean AS $$
DECLARE
  distance_km numeric;
BEGIN
  -- Haversine formula for distance calculation
  distance_km := (
    6371 * acos(
      cos(radians(customer_lat)) * 
      cos(radians(store_lat)) * 
      cos(radians(store_lng) - radians(customer_lng)) + 
      sin(radians(customer_lat)) * 
      sin(radians(store_lat))
    )
  );
  
  RETURN distance_km <= radius_km;
END;
$$ LANGUAGE plpgsql;

CREATE OR REPLACE FUNCTION is_eligible_for_first_order_discount(
  customer_id_param uuid,
  required_first_n_orders integer
)
RETURNS boolean AS $$
DECLARE
  completed_orders_count integer;
BEGIN
  -- Count completed orders for this customer
  SELECT COUNT(*) INTO completed_orders_count
  FROM customer_orders
  WHERE customer_id = customer_id_param
    AND status = 'order_delivered';
  
  -- Customer is eligible if they have less than N completed orders
  RETURN completed_orders_count < required_first_n_orders;
END;
$$ LANGUAGE plpgsql;

CREATE OR REPLACE FUNCTION check_order_completion()
RETURNS TRIGGER AS $$
BEGIN
  -- Only process when a store_order is marked as delivered
  IF NEW.status = 'order_delivered' THEN
    -- Check if all store_orders for this customer_order are delivered or cancelled
    IF NOT EXISTS (
      SELECT 1 
      FROM store_orders 
      WHERE customer_order_id = NEW.customer_order_id 
        AND status NOT IN ('order_delivered', 'order_cancelled')
    ) THEN
      -- All store orders are complete, mark customer_order as delivered
      UPDATE customer_orders 
      SET 
        status = 'order_delivered',
        delivered_at = now(),
        updated_at = now()
      WHERE id = NEW.customer_order_id
        AND status != 'order_delivered'; -- Only update if not already delivered
    END IF;
  END IF;
  
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- ===== TRIGGERS =====

CREATE TRIGGER update_app_users_updated_at BEFORE UPDATE ON app_users
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_customers_updated_at BEFORE UPDATE ON customers
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_customer_saved_addresses_updated_at BEFORE UPDATE ON customer_saved_addresses
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_stores_updated_at BEFORE UPDATE ON stores
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_products_updated_at BEFORE UPDATE ON products
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_master_products_updated_at BEFORE UPDATE ON master_products
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_categories_updated_at BEFORE UPDATE ON categories
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_customer_orders_updated_at BEFORE UPDATE ON customer_orders
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_store_orders_updated_at BEFORE UPDATE ON store_orders
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER trigger_check_order_completion AFTER UPDATE OF status ON store_orders
  FOR EACH ROW
  WHEN (NEW.status = 'order_delivered')
  EXECUTE FUNCTION check_order_completion();

CREATE TRIGGER update_admins_updated_at BEFORE UPDATE ON admins
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- SECTION 10: VIEWS FOR COMMON QUERIES
-- ============================================================================

-- View: Products with master product details
CREATE OR REPLACE VIEW products_with_details AS
SELECT 
  p.id,
  p.store_id,
  p.quantity AS stock_quantity,
  p.is_active AS available_in_store,
  mp.id AS master_product_id,
  mp.name,
  mp.category,
  mp.brand,
  mp.description,
  mp.image_url,
  mp.base_price AS mrp,
  mp.discounted_price AS price,
  mp.unit,
  mp.is_loose,
  mp.min_quantity,
  mp.max_quantity,
  mp.rating,
  mp.rating_count,
  s.name AS store_name,
  s.latitude AS store_latitude,
  s.longitude AS store_longitude
FROM products p
JOIN master_products mp ON p.master_product_id = mp.id
JOIN stores s ON p.store_id = s.id
WHERE p.is_active = true AND mp.is_active = true AND s.is_active = true;

-- View: Order summary with details (multi-store aware)
CREATE OR REPLACE VIEW order_summary AS
SELECT 
  co.id,
  co.order_code,
  co.status,
  co.payment_status,
  co.total_amount,
  co.placed_at,
  u.name AS customer_name,
  u.phone AS customer_phone,
  COUNT(DISTINCT so.store_id) AS total_stores,
  COUNT(DISTINCT so.delivery_partner_id) AS total_delivery_partners,
  COUNT(oi.id) AS total_items
FROM customer_orders co
JOIN app_users u ON co.customer_id = u.id
LEFT JOIN store_orders so ON so.customer_order_id = co.id
LEFT JOIN order_items oi ON oi.store_order_id = so.id
GROUP BY co.id, u.name, u.phone;

-- View: Store order details (for shopkeeper dashboard)
CREATE OR REPLACE VIEW store_order_details AS
SELECT 
  so.id AS store_order_id,
  so.customer_order_id,
  co.order_code,
  so.store_id,
  s.name AS store_name,
  so.status AS store_status,
  so.subtotal_amount,
  so.delivery_fee,
  so.delivery_partner_id,
  dp.name AS delivery_partner_name,
  u.name AS customer_name,
  u.phone AS customer_phone,
  co.delivery_address,
  COUNT(oi.id) AS item_count
FROM store_orders so
JOIN customer_orders co ON co.id = so.customer_order_id
JOIN stores s ON s.id = so.store_id
JOIN app_users u ON u.id = co.customer_id
LEFT JOIN app_users dp ON dp.id = so.delivery_partner_id
LEFT JOIN order_items oi ON oi.store_order_id = so.id
GROUP BY so.id, co.id, co.order_code, s.name, u.name, u.phone, co.delivery_address, dp.name;

-- ============================================================================
-- SECTION 11: SAMPLE DATA FOR SUPER ADMIN (OPTIONAL)
-- ============================================================================

-- Insert default super admin (CHANGE PASSWORD IN PRODUCTION!)
-- Password: 'SuperAdmin@123' (hashed with bcrypt)
INSERT INTO admins (email, password_hash, full_name, role, status) VALUES
('superadmin@platform.com', 
 '$2a$10$abcdefghijklmnopqrstuvwxyz1234567890ABCDEFG', -- Replace with actual bcrypt hash
 'Super Administrator',
 'super_admin',
 'active'
) ON CONFLICT (email) DO NOTHING;

-- Insert categories from existing data
INSERT INTO categories (name, description, image_url, display_order) VALUES
('Pasta, Noodles and Vermicelli', 'Fresh & Instant Pasta and Noodles', 'https://media.canva.com/v2/image-resize/format:JPG/height:1200/quality:92/uri:ifs%3A%2F%2FM%2Fb3c2c453-048a-4698-ab8a-5cc52f230f5e/watermark:F/width:1200', 9),
('Personal Care', 'Premium personal care products for your daily hygiene and beauty needs', 'https://media.canva.com/v2/image-resize/format:JPG/height:1200/quality:92/uri:ifs%3A%2F%2FM%2F8403ef37-4a30-44d5-a5a7-7dd4df5e599c/watermark:F/width:1200', 8),
('Vegetables', 'Fresh & Healthy Vegetables', 'https://media.canva.com/v2/image-resize/format:JPG/height:1200/quality:92/uri:ifs%3A%2F%2FM%2F5ce4974d-d18f-4a82-8bcd-bc11f46069fc/watermark:F/width:1200', 4),
('Beverages', 'Refreshing Drinks', 'https://media.canva.com/v2/image-resize/format:JPG/height:1200/quality:92/uri:ifs%3A%2F%2FM%2Fd6f592ce-6d57-4d92-8513-973d3e8cf61d/watermark:F/width:1200', 5),
('Soft Drinks', '', 'https://media.canva.com/v2/image-resize/format:JPG/height:1200/quality:92/uri:ifs%3A%2F%2FM%2F4b1e6cc9-838e-45ac-b11e-4191ab40e11c/watermark:F/width:1200', 0),
('Snacks', 'Tasty Snacks and Treats', 'https://media.canva.com/v2/image-resize/format:JPG/height:1200/quality:92/uri:ifs%3A%2F%2FM%2Fadf81a91-6728-4462-92d8-5b98319e7c8f/watermark:F/width:1200', 6),
('Breakfast Cereals', 'Start your day right with healthy breakfast cereals, oats, and muesli', 'https://media.canva.com/v2/image-resize/format:JPG/height:1200/quality:92/uri:ifs%3A%2F%2FM%2Fac523d73-a2ae-4c8a-9f10-c61593bd6894/watermark:F/width:1200', 2),
('Spices', 'Fresh & Aromatic Spices', 'https://media.canva.com/v2/image-resize/format:JPG/height:1200/quality:92/uri:ifs%3A%2F%2FM%2Fc6ebff31-2e3e-41fb-ab31-4b699ddde136/watermark:F/width:1200', 2),
('Ketchup and Sauces', 'Delicious ketchups, sauces, mayonnaise, and condiments for every meal', 'https://media.canva.com/v2/image-resize/format:JPG/height:1200/quality:92/uri:ifs%3A%2F%2FM%2F6c99d8f7-a6d2-4736-ad54-62f4a9869dd7/watermark:F/width:1200', 7),
('Dairy', 'Milk, Paneer & more', 'https://media.istockphoto.com/id/544807136/photo/various-fresh-dairy-products.jpg', 3),
('Bakery', 'Fresh baked goods, biscuits, cookies and delicious treats', 'https://media.canva.com/v2/image-resize/format:JPG/height:1200/quality:92/uri:ifs%3A%2F%2FM%2F3a82f8da-4293-4470-8a9c-a35810fd60fd/watermark:F/width:1200', 1),
('Detergents', 'Powerful detergents and fabric care products for clean, fresh clothes', 'https://media.canva.com/v2/image-resize/format:JPG/height:1200/quality:92/uri:ifs%3A%2F%2FM%2F19e12ccb-63d4-4a6e-9d5e-ff4656d42c72/watermark:F/width:1200', 5),
('Dry Fruits', 'Premium quality dry fruits, nuts, and seeds for healthy snacking', 'https://nutribinge.in/cdn/shop/articles/image3.jpg', 6),
('Staples', 'Rice, Dal, Atta & Maida', 'https://media.canva.com/v2/image-resize/format:JPG/height:1200/quality:92/uri:ifs%3A%2F%2FM%2Fd7f43bb5-13e1-47b2-b24e-1ca3a8fab17d/watermark:F/width:1200', 1),
('Oils', 'High-quality cooking oils for all your culinary needs', 'https://media.canva.com/v2/image-resize/format:JPG/height:1200/quality:92/uri:ifs%3A%2F%2FM%2F379b9235-390c-414b-a9c8-dc740e75353d/watermark:F/width:1200', 8),
('Salt and Sugar', 'Essential Cooking Ingredients', 'https://media.canva.com/v2/image-resize/format:JPG/height:1200/quality:92/uri:ifs%3A%2F%2FM%2F7141a6ab-d845-46b1-9165-d3cab0af7a33/watermark:F/width:1200', 10),
('Chocolates and Candies', 'Indulge in delicious chocolates, candies, and sweet treats', 'https://media.istockphoto.com/id/522735736/photo/chocolate-background.jpg', 3)
ON CONFLICT (name) DO NOTHING;

-- Insert default first order discount coupon (15% off for first 3 orders)
INSERT INTO coupons (code, coupon_type, discount_value, applies_to_first_n_orders, max_discount_amount, is_active) VALUES
('FIRST3ORDERS', 'first_order_discount', 15, 3, 100, true)
ON CONFLICT (code) DO NOTHING;

-- Example usage in application:
-- 1. Customer applies coupon 'FIRST3ORDERS'
-- 2. Backend checks: SELECT is_eligible_for_first_order_discount(customer_id, 3)
-- 3. If true, apply 15% discount (max â‚¹100)
-- 4. After order completes, customer has used 1 of their 3 first-order discounts

-- ============================================================================
-- SCHEMA MIGRATION COMPLETE
-- ============================================================================
-- Total tables created: 32
-- Indexes created: 56+
-- Views created: 3
-- Functions created: 6
-- Triggers created: 11
-- Enums created: 7
-- ============================================================================

COMMENT ON SCHEMA public IS 'Multi-vendor quick commerce platform with admin panel';
COMMENT ON TABLE master_products IS 'Admin-controlled product catalog. Shopkeepers select from this list. Price control is admin-only. base_price = MRP, discounted_price = Selling Price.';
COMMENT ON TABLE products IS 'Store-owned inventory. Price inherited from master_products. Shopkeepers can only modify quantity and availability.';
COMMENT ON TABLE admins IS 'Super admin has all permissions. Regular admins have custom RBAC via permissions JSONB.';
COMMENT ON COLUMN master_products.is_loose IS 'True for products sold by weight/volume (e.g., Loose Atta, Loose Rice). False for pre-packaged products with fixed sizes.';
COMMENT ON COLUMN master_products.base_price IS 'MRP (Maximum Retail Price) - the printed price on product.';
COMMENT ON COLUMN master_products.discounted_price IS 'Actual selling price set by admin. Must be <= base_price.';
COMMENT ON COLUMN order_items.quantity IS 'Can be decimal for loose products (e.g., 0.5 kg tomatoes, 1.5 kg rice).';
COMMENT ON COLUMN coupons.applies_to_first_n_orders IS 'Apply discount to first N orders only. E.g., 3 = first 3 orders get discount.';
COMMENT ON FUNCTION is_store_in_range IS 'Check if store is within delivery radius of customer location using Haversine formula. Used for 1km, 2km, 3km radius search.';